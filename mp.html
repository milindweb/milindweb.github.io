<!-- FULL ROBUST IMPLEMENTATION -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Milindweb Search Portal</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; }
    header { background:#003366; color:#fff; padding:10px; text-align:center; }
    main { padding:10px; }
    .hidden { display:none; }
    .folder, .file { margin:3px 0; padding:6px; border:1px solid #ccc; border-radius:4px; }
    .folder { background:#eef; cursor:pointer; }
    .file { background:#fafafa; }
    .tree { margin-left:18px; }
    .highlight { background:yellow; }
    table { border-collapse:collapse; width:100%; }
    th, td { border:1px solid #ccc; padding:6px; }
    th { background:#f0f0f0; position:sticky; top:0; }
  </style>
</head>
<body>
<header><h1>Milindweb Search Portal</h1></header>
<main>
  <label>Source:</label>
  <select id="source">
    <option value="drive">Google Drive</option>
    <option value="sheet">Google Sheet</option>
  </select>
  <input type="password" id="password" placeholder="Enter password">
  <input type="checkbox" onclick="togglePwd()"> Show Password
  <button onclick="login()">Submit</button>

  <div id="searchBox" class="hidden">
    <input type="text" id="search" placeholder="Search..." oninput="suggest()">
    <button onclick="performSearch()">Search</button>
    <ul id="suggestions" style="list-style:none; padding:0; margin:5px 0;"></ul>
  </div>

  <div id="results"></div>
</main>
<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxSqnkHPwOd12v93JSvqGSoHQOWhao2r7-DRvXjflnAEHpT2qcXg11EHDIY1flJmCkW/exec";
let currentSource = "";
let currentKey = "";
let fullData = null;

function togglePwd() {
  const pwd = document.getElementById("password");
  pwd.type = pwd.type === "password" ? "text" : "password";
}

async function login() {
  currentSource = document.getElementById("source").value;
  currentKey = document.getElementById("password").value;
  document.getElementById("searchBox").classList.remove("hidden");
  await loadData();
}

async function loadData(query="") {
  try {
    const res = await fetch(`${API_URL}?source=${currentSource}&key=${currentKey}&q=${encodeURIComponent(query)}`);
    const data = await res.json();
    if (data.error) {
      document.getElementById("results").innerHTML = `<p style='color:red'>${data.error}</p>`;
      return;
    }
    fullData = data;
    renderResults(data);
  } catch (err) {
    document.getElementById("results").innerHTML = `<p style='color:red'>Error: ${err.message}</p>`;
  }
}

function performSearch() {
  const q = document.getElementById("search").value.toLowerCase();
  loadData(q);
}

function renderResults(data) {
  const container = document.getElementById("results");
  container.innerHTML = "";

  if (currentSource === "sheet") {
    if (!Array.isArray(data) || data.length === 0) { container.innerHTML = "<p>No results</p>"; return; }
    let table = "<table><thead><tr>";
    Object.keys(data[0]).forEach(h => table += `<th>${h}</th>`);
    table += "</tr></thead><tbody>";
    data.forEach(row => {
      table += "<tr>";
      Object.values(row).forEach(val => table += `<td>${highlight(val)}</td>`);
      table += "</tr>";
    });
    table += "</tbody></table>";
    container.innerHTML = table;
  } else if (currentSource === "drive") {
    renderFolder(container, data);
  }
}

function renderFolder(container, folder) {
  const div = document.createElement("div");
  div.className = "folder";
  div.textContent = `📁 ${folder.name || "Unnamed"} (${(folder.files||[]).length} files)`;
  const treeDiv = document.createElement("div");
  treeDiv.className = "tree";
  treeDiv.style.display = "none";

  div.onclick = () => {
    const allTrees = document.querySelectorAll(".tree");
    allTrees.forEach(t => t.style.display = "none");
    treeDiv.style.display = "block";
  };

  (folder.files||[]).forEach(file => {
    const fileDiv = document.createElement("div");
    fileDiv.className = "file";
    fileDiv.innerHTML = `${highlight(file.name)} - ${file.size} <a href="${file.preview}" target="_blank">Preview</a> | <a href="${file.download}" target="_blank">Download</a>`;
    treeDiv.appendChild(fileDiv);
  });

  (folder.subfolders||[]).forEach(sub => {
    renderFolder(treeDiv, sub);
  });

  container.appendChild(div);
  container.appendChild(treeDiv);
}

function highlight(text) {
  const q = document.getElementById("search").value.toLowerCase();
  if (!q) return text;
  try {
    const regex = new RegExp(`(${q})`, "gi");
    return String(text).replace(regex, '<span class="highlight">$1</span>');
  } catch {
    return text;
  }
}

function suggest() {
  const q = document.getElementById("search").value.toLowerCase();
  const list = document.getElementById("suggestions");
  list.innerHTML = "";
  if (!q || !fullData) return;
  let suggestions = [];
  if (currentSource === "sheet" && Array.isArray(fullData)) {
    suggestions = fullData.flatMap(row => Object.values(row))
      .filter(v => String(v).toLowerCase().includes(q))
      .slice(0,5);
  } else if (currentSource === "drive") {
    const gather = (f) => {
      (f.files||[]).forEach(file => {
        if (file.name.toLowerCase().includes(q)) suggestions.push(file.name);
      });
      (f.subfolders||[]).forEach(sub => gather(sub));
    };
    gather(fullData);
    suggestions = suggestions.slice(0,5);
  }
  suggestions.forEach(s => {
    const li = document.createElement("li");
    li.textContent = s;
    li.onclick = () => { document.getElementById("search").value = s; performSearch(); };
    list.appendChild(li);
  });
}
</script>
</body>
</html>
