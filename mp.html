<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Drive & Sheet Viewer</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  .hidden { display: none; }
  input, select, button { margin: 5px; padding: 8px; }
  #results { margin-top: 20px; }
  .file, .folder { margin-left: 20px; }
  .file a { text-decoration: none; color: blue; }
  table { border-collapse: collapse; width: 100%; margin-top: 10px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
</style>
</head>
<body>

<h2>Secure Drive & Sheet Viewer</h2>

<label for="source">Select Source:</label>
<select id="source">
  <option value="drive">Drive</option>
  <option value="sheet">Sheet</option>
</select>

<input type="password" id="password" placeholder="Enter password">
<button onclick="authenticate()">Submit</button>

<div id="searchSection" class="hidden">
  <input type="text" id="searchBox" placeholder="Search...">
  <button onclick="fetchData()">Search</button>
  <div id="results"></div>
</div>

<script>
const BACKEND_URL = "https://script.google.com/macros/s/AKfycbxSqnkHPwOd12v93JSvqGSoHQOWhao2r7-DRvXjflnAEHpT2qcXg11EHDIY1flJmCkW/exec"; // Replace with your deployed Apps Script Web App URL

let currentSource = "";
let accessKey = "";

// Authenticate user
function authenticate() {
  currentSource = document.getElementById("source").value;
  accessKey = document.getElementById("password").value.trim();

  if (!accessKey) {
    alert("Please enter a password.");
    return;
  }

  document.getElementById("searchSection").classList.remove("hidden");
  fetchData(); // load initial tree/table
}

// Fetch and display data
async function fetchData() {
  const query = document.getElementById("searchBox").value.trim().toLowerCase();
  const url = `${BACKEND_URL}?source=${currentSource}&key=${accessKey}&q=${encodeURIComponent(query)}`;

  try {
    const response = await fetch(url);
    const data = await response.json();
    renderResults(data);
  } catch (err) {
    document.getElementById("results").innerHTML = `<p style="color:red">Error: ${err.message}</p>`;
  }
}

// Render results
function renderResults(data) {
  const container = document.getElementById("results");
  container.innerHTML = "";

  if (data.error) {
    container.innerHTML = `<p style="color:red">${data.error}</p>`;
    return;
  }

  if (currentSource === "drive") {
    // Drive tree view
    const ul = document.createElement("ul");
    data.forEach(file => {
      const li = document.createElement("li");
      li.classList.add("file");
      li.innerHTML = `
        ðŸ“„ <strong>${file.name}</strong> (${file.size})
        [<a href="${file.preview}" target="_blank">Preview</a>]
        [<a href="${file.download}" target="_blank">Download</a>]
      `;
      ul.appendChild(li);
    });
    container.appendChild(ul);

  } else if (currentSource === "sheet") {
    // Sheet live table
    if (data.length === 0) {
      container.innerHTML = "<p>No matching records found.</p>";
      return;
    }

    const table = document.createElement("table");
    const headers = Object.keys(data[0]);
    const thead = document.createElement("thead");
    const headerRow = document.createElement("tr");

    headers.forEach(h => {
      const th = document.createElement("th");
      th.textContent = h;
      headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    table.appendChild(thead);

    const tbody = document.createElement("tbody");
    data.forEach(row => {
      const tr = document.createElement("tr");
      headers.forEach(h => {
        const td = document.createElement("td");
        td.textContent = row[h];
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);

    container.appendChild(table);
  }
}
</script>

</body>
</html>
