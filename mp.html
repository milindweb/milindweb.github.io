<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Drive & Sheet Viewer</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  .hidden { display: none; }
  input, select, button { margin: 5px; padding: 8px; }
  ul { list-style: none; padding-left: 20px; }
  li { margin: 4px 0; }
  .folder { font-weight: bold; cursor: pointer; }
  table { border-collapse: collapse; width: 100%; margin-top: 15px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
</style>
</head>
<body>

<h2>Secure Drive & Sheet Viewer</h2>

<label for="source">Select Source:</label>
<select id="source">
  <option value="drive">Drive</option>
  <option value="sheet">Sheet</option>
</select>

<input type="password" id="password" placeholder="Enter password">
<button onclick="authenticate()">Submit</button>

<div id="searchSection" class="hidden">
  <input type="text" id="searchBox" placeholder="Search...">
  <button onclick="fetchData()">Search</button>
  <div id="results"></div>
</div>

<script>
const BACKEND_URL = "https://script.google.com/macros/s/AKfycbxSqnkHPwOd12v93JSvqGSoHQOWhao2r7-DRvXjflnAEHpT2qcXg11EHDIY1flJmCkW/exec"; // Replace with your Apps Script Web App URL
let currentSource = "";
let accessKey = "";

function authenticate() {
  currentSource = document.getElementById("source").value;
  accessKey = document.getElementById("password").value.trim();

  if (!accessKey) {
    alert("Please enter a password.");
    return;
  }

  document.getElementById("searchSection").classList.remove("hidden");
  fetchData();
}

async function fetchData() {
  const query = document.getElementById("searchBox").value.trim().toLowerCase();
  const url = `${BACKEND_URL}?source=${currentSource}&key=${accessKey}&q=${encodeURIComponent(query)}`;

  try {
    const response = await fetch(url);
    const data = await response.json();
    renderResults(data);
  } catch (err) {
    document.getElementById("results").innerHTML = `<p style="color:red">Error: ${err.message}</p>`;
  }
}

function renderResults(data) {
  const container = document.getElementById("results");
  container.innerHTML = "";

  if (data.error) {
    container.innerHTML = `<p style="color:red">${data.error}</p>`;
    return;
  }

  if (currentSource === "drive") {
    const ul = document.createElement("ul");
    data.forEach(item => renderDriveItem(item, ul));
    container.appendChild(ul);
  } else if (currentSource === "sheet") {
    if (data.length === 0) {
      container.innerHTML = "<p>No matching records found.</p>";
      return;
    }

    const table = document.createElement("table");
    const headers = Object.keys(data[0]);
    const thead = document.createElement("thead");
    const headerRow = document.createElement("tr");

    headers.forEach(h => {
      const th = document.createElement("th");
      th.textContent = h;
      headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    table.appendChild(thead);

    const tbody = document.createElement("tbody");
    data.forEach(row => {
      const tr = document.createElement("tr");
      headers.forEach(h => {
        const td = document.createElement("td");
        td.textContent = row[h];
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);

    container.appendChild(table);
  }
}

function renderDriveItem(item, parentEl) {
  const li = document.createElement("li");

  if (item.type === "folder") {
    li.innerHTML = `üìÅ <span class="folder" onclick="toggleFolder(this)">${item.name}</span>`;
    if (item.children.length > 0) {
      const ul = document.createElement("ul");
      ul.style.display = "none";
      item.children.forEach(child => renderDriveItem(child, ul));
      li.appendChild(ul);
    }
  } else if (item.type === "file") {
    li.innerHTML = `üìÑ ${item.name} (${item.size}) [<a href="${item.preview}" target="_blank">Preview</a>] [<a href="${item.download}" target="_blank">Download</a>]`;
  }

  parentEl.appendChild(li);
}

function toggleFolder(el) {
  const nextUl = el.parentElement.querySelector("ul");
  if (nextUl) {
    nextUl.style.display = nextUl.style.display === "none" ? "block" : "none";
  }
}
</script>

</body>
</html>
