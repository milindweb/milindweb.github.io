<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Milindweb Search Portal</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 10px; }
    .hidden { display: none; }
    .folder { cursor: pointer; margin: 5px 0; font-weight: bold; }
    .tree { margin-left: 20px; padding-left: 10px; border-left: 1px solid #ccc; }
    .file { margin: 3px 0; }
    .highlight { background: yellow; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 5px; text-align: left; }
    th { background: #f2f2f2; position: sticky; top: 0; }
    #suggestions { list-style: none; padding: 0; margin: 5px 0; }
    #suggestions li { cursor: pointer; padding: 3px; border: 1px solid #ccc; margin-top: 2px; background: #fafafa; }
    #loading { font-style: italic; color: #555; }
  </style>
</head>
<body>
  <h2>Milindweb Search Portal</h2>

  <div>
    <label for="source">Select Source:</label>
    <select id="source">
      <option value="drive">Google Drive</option>
      <option value="sheet">Google Sheet</option>
    </select>
    <br><br>
    <input type="password" id="password" placeholder="Enter Password">
    <input type="checkbox" onclick="togglePwd()"> Show Password
    <button onclick="login()">Submit</button>
  </div>

  <div id="searchBox" class="hidden">
    <input type="text" id="search" placeholder="Search..." onkeyup="suggest()">
    <button onclick="performSearch()">Search</button>
    <ul id="suggestions"></ul>
  </div>

  <div id="loading" class="hidden">Loading data, please wait...</div>
  <div id="results"></div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxSqnkHPwOd12v93JSvqGSoHQOWhao2r7-DRvXjflnAEHpT2qcXg11EHDIY1flJmCkW/exec";
    let currentSource = "";
    let currentKey = "";
    let fullData = null;

    function togglePwd() {
      const pwd = document.getElementById("password");
      pwd.type = pwd.type === "password" ? "text" : "password";
    }

    async function login() {
      currentSource = document.getElementById("source").value;
      currentKey = document.getElementById("password").value;
      document.getElementById("searchBox").classList.remove("hidden");
      await loadData(); // auto-load everything on login
    }

    async function loadData(query="") {
      document.getElementById("loading").classList.remove("hidden");
      document.getElementById("results").innerHTML = "";
      try {
        const res = await fetch(`${API_URL}?source=${currentSource}&key=${currentKey}&q=${encodeURIComponent(query)}`);
        const data = await res.json();
        document.getElementById("loading").classList.add("hidden");
        if (data.error) {
          document.getElementById("results").innerHTML = `<p style='color:red'>${data.error}</p>`;
          return;
        }
        fullData = data;
        renderResults(data);
      } catch (err) {
        document.getElementById("loading").classList.add("hidden");
        document.getElementById("results").innerHTML = `<p style='color:red'>Error: ${err.message}</p>`;
      }
    }

    function performSearch() {
      const q = document.getElementById("search").value.toLowerCase();
      loadData(q);
    }

    function renderResults(data) {
      const container = document.getElementById("results");
      container.innerHTML = "";

      if (currentSource === "sheet") {
        if (!Array.isArray(data) || data.length === 0) { container.innerHTML = "<p>No results</p>"; return; }
        let table = "<table><thead><tr>";
        Object.keys(data[0]).forEach(h => table += `<th>${h}</th>`);
        table += "</tr></thead><tbody>";
        data.forEach(row => {
          table += "<tr>";
          Object.values(row).forEach(val => table += `<td>${highlight(val)}</td>`);
          table += "</tr>";
        });
        table += "</tbody></table>";
        container.innerHTML = table;
      } else if (currentSource === "drive") {
        renderFolder(container, data, true); // auto-expand root
      }
    }

    function renderFolder(container, folder, autoExpand=false) {
      const div = document.createElement("div");
      div.className = "folder";
      div.textContent = `📁 ${folder.name || "Unnamed"} (${(folder.files||[]).length} files)`;
      const treeDiv = document.createElement("div");
      treeDiv.className = "tree";
      treeDiv.style.display = autoExpand ? "block" : "none";

      div.onclick = () => {
        const allTrees = document.querySelectorAll(".tree");
        allTrees.forEach(t => t.style.display = "none");
        treeDiv.style.display = "block";
      };

      (folder.files||[]).forEach(file => {
        const fileDiv = document.createElement("div");
        fileDiv.className = "file";
        fileDiv.innerHTML = `${highlight(file.name)} - ${file.size} 
          <a href="${file.preview}" target="_blank">Preview</a> | 
          <a href="${file.download}" target="_blank" download>Download</a>`;
        treeDiv.appendChild(fileDiv);
      });

      (folder.subfolders||[]).forEach(sub => {
        renderFolder(treeDiv, sub);
      });

      container.appendChild(div);
      container.appendChild(treeDiv);
    }

    function highlight(text) {
      const q = document.getElementById("search").value.toLowerCase();
      if (!q) return text;
      try {
        const regex = new RegExp(`(${q})`, "gi");
        return String(text).replace(regex, '<span class="highlight">$1</span>');
      } catch {
        return text;
      }
    }

    function suggest() {
      const q = document.getElementById("search").value.toLowerCase();
      const list = document.getElementById("suggestions");
      list.innerHTML = "";
      if (!q || !fullData) return;
      let suggestions = [];
      if (currentSource === "sheet" && Array.isArray(fullData)) {
        suggestions = fullData.flatMap(row => Object.values(row))
          .filter(v => String(v).toLowerCase().includes(q))
          .slice(0,5);
      } else if (currentSource === "drive") {
        const gather = (f) => {
          (f.files||[]).forEach(file => {
            if (file.name.toLowerCase().includes(q)) suggestions.push(file.name);
          });
          (f.subfolders||[]).forEach(sub => gather(sub));
        };
        gather(fullData);
        suggestions = suggestions.slice(0,5);
      }
      suggestions.forEach(s => {
        const li = document.createElement("li");
        li.textContent = s;
        li.onclick = () => { document.getElementById("search").value = s; performSearch(); };
        list.appendChild(li);
      });
    }
  </script>
</body>
</html>