<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Secure Search</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 10px; background: #f4f4f4; }
    .search-bar { display:flex; flex-wrap:wrap; gap:8px; margin-bottom:15px; }
    input, select, button { padding:8px; font-size:14px; border-radius:5px; border:1px solid #ccc; }
    button { background:#0066cc; color:#fff; cursor:pointer; }
    button:hover { background:#004c99; }

    /* Results */
    .results { display:flex; flex-direction:column; gap:12px; }
    .card { display:flex; align-items:center; background:#fff; border:1px solid #ddd;
            border-radius:6px; padding:8px; box-shadow:0 1px 3px rgba(0,0,0,0.1); }
    .card img { width:60px; height:80px; object-fit:cover; border-radius:4px; margin-right:10px; }
    .card-body { flex:1; }
    .card-title { font-size:14px; font-weight:bold; margin-bottom:4px; }
    .card a { background:#0066cc; color:#fff; padding:4px 8px; font-size:12px; border-radius:4px;
              text-decoration:none; display:inline-block; margin-right:6px; }
    .card a:hover { background:#004c99; }

    /* Table for sheet */
    table { border-collapse: collapse; width: 100%; background:#fff; }
    th, td { border:1px solid #ddd; padding:8px; font-size:13px; }
    th { background:#0066cc; color:#fff; }

    /* Modal */
    .modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%;
             background:rgba(0,0,0,0.7); }
    .modal-content { background:#fff; margin:5% auto; padding:10px; border-radius:6px; 
                     width:90%; max-width:800px; height:80%; display:flex; flex-direction:column; }
    .close { align-self:flex-end; font-size:22px; cursor:pointer; color:#333; }
    iframe { flex:1; width:100%; border:none; }
  </style>
</head>
<body>

<h2>üîç Secure Search Portal</h2>
<div class="search-bar">
  <input type="text" id="query" placeholder="Enter search keyword">
  <select id="source">
    <option value="drive">Documents (Drive)</option>
    <option value="sheet">Google Sheet</option>
  </select>
  <input type="password" id="password" placeholder="Enter Password">
  <button onclick="performSearch()">Search</button>
</div>

<div id="results" class="results"></div>

<!-- Modal for preview -->
<div id="previewModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <iframe id="previewFrame" src=""></iframe>
  </div>
</div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycby1NITq7ct26UmJkTvmvAT7_MyfchgmoEAk21pMdtGTT9FQ4D4rMGbTv-WEhwzcjO0/exec";

// Perform search
async function performSearch() {
  const query = document.getElementById("query").value.toLowerCase();
  const source = document.getElementById("source").value;
  const password = document.getElementById("password").value;

  if (!query || !password) {
    alert("Please enter search text and password.");
    return;
  }

  const url = `${WEB_APP_URL}?source=${source}&key=${password}`;
  try {
    const res = await fetch(url);
    const data = await res.json();
    if (data.error) {
      document.getElementById("results").innerHTML = `<p style="color:red">${data.error}</p>`;
      return;
    }
    if (source === "sheet") renderSheet(data, query);
    else renderDrive(data, query);
  } catch (err) {
    document.getElementById("results").innerHTML = `<p style="color:red">Error: ${err}</p>`;
  }
}

// Render Google Sheet Data
function renderSheet(data, q) {
  const filtered = data.filter(row =>
    Object.values(row).some(val => String(val).toLowerCase().includes(q))
  );
  if (filtered.length === 0) {
    document.getElementById("results").innerHTML = "<p>No results found.</p>";
    return;
  }
  let html = "<table><tr>";
  Object.keys(filtered[0]).forEach(h => { html += `<th>${h}</th>`; });
  html += "</tr>";
  filtered.forEach(row => {
    html += "<tr>";
    Object.values(row).forEach(val => { html += `<td>${val}</td>`; });
    html += "</tr>";
  });
  html += "</table>";
  document.getElementById("results").innerHTML = html;
}

// Render Google Drive Files
function renderDrive(data, q) {
  const filtered = data.filter(f => f.name.toLowerCase().includes(q));
  if (filtered.length === 0) {
    document.getElementById("results").innerHTML = "<p>No results found.</p>";
    return;
  }
  const resultsDiv = document.getElementById("results");
  resultsDiv.innerHTML = "";
  filtered.forEach(f => {
    let div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      <img src="${f.thumbnail}" alt="Preview">
      <div class="card-body">
        <div class="card-title">${f.name}</div>
        <a href="${f.download}" target="_blank">Download (${f.size})</a>
        <a href="#" onclick="openPreview('${f.preview}');return false;">Preview</a>
      </div>
    `;
    resultsDiv.appendChild(div);
  });
}

// Modal Preview
function openPreview(url) {
  document.getElementById("previewFrame").src = url;
  document.getElementById("previewModal").style.display = "block";
}
document.querySelector(".close").onclick = () => {
  document.getElementById("previewModal").style.display = "none";
  document.getElementById("previewFrame").src = "";
};
window.onclick = (event) => {
  if (event.target == document.getElementById("previewModal")) {
    document.getElementById("previewModal").style.display = "none";
    document.getElementById("previewFrame").src = "";
  }
};
</script>

</body>
</html>
