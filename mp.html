// highlight text helper
function highlight(text, query) {
  if (!query) return text;
  const re = new RegExp("(" + query + ")", "gi");
  return text.replace(re, "<mark>$1</mark>");
}

// filter with autocomplete
function filterTree(folder, query) {
  if (!folder) return null;
  const subfolders = (folder.subfolders || []).map(sub => filterTree(sub, query)).filter(Boolean);
  const files = (folder.files || []).filter(file =>
    file.name.toLowerCase().includes(query)
  );
  if (files.length > 0 || subfolders.length > 0 || folder.name.toLowerCase().includes(query)) {
    return { ...folder, files, subfolders };
  }
  return null;
}

function renderResults(data) {
  resultsDiv.innerHTML = "";
  if (!data) {
    resultsDiv.innerHTML = "<em>No results</em>";
    return;
  }

  if (selectedSource === "drive") {
    const root = createFolder(data, searchBox.value.trim().toLowerCase());
    root.querySelector(".folder-content").style.display = "block";
    resultsDiv.appendChild(root);
  } else {
    const headers = Object.keys(data[0]);
    const table = document.createElement("table");
    const thead = document.createElement("thead");
    const headerRow = document.createElement("tr");
    headers.forEach(h => {
      const th = document.createElement("th");
      th.textContent = h;
      headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    table.appendChild(thead);
    const tbody = document.createElement("tbody");
    data.forEach(row => {
      const tr = document.createElement("tr");
      headers.forEach(h => {
        const td = document.createElement("td");
        td.innerHTML = highlight(String(row[h] || ""), searchBox.value.trim().toLowerCase());
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    resultsDiv.appendChild(table);
  }
}

function createFolder(folder, query) {
  const folderDiv = document.createElement("div");
  folderDiv.className = "folder";

  const header = document.createElement("div");
  header.className = "folder-header";
  const fileCount = countFiles(folder);
  header.innerHTML = `📁 ${highlight(folder.name, query)} (${fileCount} files)`;
  folderDiv.appendChild(header);

  const content = document.createElement("div");
  content.className = "folder-content";

  if (folder.files && folder.files.length > 0) {
    const table = document.createElement("table");
    const thead = document.createElement("thead");
    const trHead = document.createElement("tr");
    ["File Name","Type","Size","Preview","Download"].forEach(h => {
      const th = document.createElement("th");
      th.textContent = h;
      trHead.appendChild(th);
    });
    thead.appendChild(trHead);
    table.appendChild(thead);

    const tbody = document.createElement("tbody");
    folder.files.forEach(file => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${highlight(file.name, query)}</td>
        <td>${file.type}</td>
        <td>${file.size}</td>
        <td><a href="${file.preview}" target="_blank">Preview</a></td>
        <td><a href="${file.download}" target="_blank">Download</a></td>
      `;
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    content.appendChild(table);
  }

  if (folder.subfolders && folder.subfolders.length > 0) {
    folder.subfolders.forEach(sub => {
      content.appendChild(createFolder(sub, query));
    });
  }

  folderDiv.appendChild(content);

  header.addEventListener("click", () => {
    const siblings = folderDiv.parentNode.querySelectorAll(".folder-content");
    siblings.forEach(s => s.style.display = "none");
    content.style.display = (content.style.display === "block") ? "none" : "block";
  });

  return folderDiv;
}
