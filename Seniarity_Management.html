<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>NAD Seniority & Promotion Management System</title>
</head>
<body>
  <h2>NAD Seniority & Promotion Management System</h2>

  <!-- Search Section -->
  <div>
    <label>Search Token Number:</label>
    <input type="text" id="tokenSearch" onkeyup="autocompleteSearch()" placeholder="Enter token no...">
    <div id="autocompleteList"></div>
  </div>

  <!-- Employee Profile -->
  <div id="employeeProfile"></div>

  <!-- Promotion Timeline -->
  <div id="promotionTimeline"></div>

  <!-- Retirement Search -->
  <h3>Retirement Search</h3>
  <label>Year: </label><input type="number" id="retYear" placeholder="YYYY">
  <button onclick="searchRetirement()">Search</button>
  <div id="retirementResults"></div>

  <script>
    // Google Sheets CSV export links
    const sheet1URL = "https://docs.google.com/spreadsheets/d/1_qwciFgPC98jL9-4j4p7qLTK639xF0Gkrddp9E4bGQo/export?format=csv&gid=0";
    const sheet2URL = "https://docs.google.com/spreadsheets/d/1_qwciFgPC98jL9-4j4p7qLTK639xF0Gkrddp9E4bGQo/export?format=csv&gid=378290522";

    let employees = [];
    let sanctionedPosts = [];

    // CSV parser
    function parseCSV(text) {
      return text.split("\n").map(row => row.split(","));
    }

    async function loadData() {
      try {
        const [sheet1Res, sheet2Res] = await Promise.all([
          fetch(sheet1URL).then(r => r.text()),
          fetch(sheet2URL).then(r => r.text())
        ]);

        const sheet1Data = parseCSV(sheet1Res);
        const sheet2Data = parseCSV(sheet2Res);

        // Sheet1 → Employees
        employees = sheet1Data.slice(1).map(r => ({
          srno: r[0],
          name: r[1],
          rank: r[2],
          token: r[3],
          category: r[4],
          location: r[5],
          dob: r[6],
          dor: r[7],
          doa: r[8],
          doreg: r[9],
          dusl: r[11],
          dssk: r[12],
          dsk: r[13],
          dhsk2: r[14],
          dhsk1: r[15],
          dmcm: r[16]
        }));

        // Sheet2 → Sanctioned Posts
        sanctionedPosts = sheet2Data.slice(1).map(r => ({
          post: r[0],
          SK: parseInt(r[1] || 0),
          HSK2: parseInt(r[2] || 0),
          HSK1: parseInt(r[3] || 0),
          MCM: parseInt(r[4] || 0)
        }));

      } catch (err) {
        console.error("Error loading data", err);
      }
    }

    // Autocomplete Search
    function autocompleteSearch() {
      const input = document.getElementById("tokenSearch").value.toLowerCase();
      const list = document.getElementById("autocompleteList");
      list.innerHTML = "";

      if (!input) return;

      const matches = employees.filter(e => e.token.toLowerCase().includes(input)).slice(0, 10);

      matches.forEach(emp => {
        const div = document.createElement("div");
        div.textContent = `${emp.token} - ${emp.name}`;
        div.style.cursor = "pointer";
        div.onclick = () => showProfile(emp.token);
        list.appendChild(div);
      });
    }

    // Show Employee Profile
    function showProfile(token) {
      const emp = employees.find(e => e.token === token);
      if (!emp) return;

      document.getElementById("employeeProfile").innerHTML = `
        <h3>Employee Profile</h3>
        <p><b>Name:</b> ${emp.name}</p>
        <p><b>Token:</b> ${emp.token}</p>
        <p><b>Rank:</b> ${emp.rank}</p>
        <p><b>Date of Current Rank:</b> ${emp[`d${emp.rank.toLowerCase()}`] || "N/A"}</p>
        <p><b>Date of Retirement:</b> ${emp.dor}</p>
      `;

      showPromotionTimeline(emp);
    }

    // Promotion Timeline
    function showPromotionTimeline(emp) {
      const timeline = [];
      const order = ["SK", "HSK2", "HSK1", "MCM"];
      const currentIndex = order.indexOf(emp.rank);

      for (let i = currentIndex + 1; i < order.length; i++) {
        const rank = order[i];
        const seniors = employees.filter(e => e.rank === rank && e.dor > new Date().toISOString().split("T")[0]).length;
        const sanctioned = sanctionedPosts.find(p => p.post === emp.category)?.[rank] || 0;
        const estimate = Math.ceil(seniors / (sanctioned || 1));

        timeline.push(`<li>${rank}: ~${estimate} years</li>`);
      }

      document.getElementById("promotionTimeline").innerHTML = `
        <h3>Promotion Timeline</h3>
        <ul>${timeline.join("") || "<li>Already at highest rank</li>"}</ul>
      `;
    }

    // Retirement Search
    function searchRetirement() {
      const year = document.getElementById("retYear").value;
      if (!year) return;

      const results = employees.filter(e => e.dor && e.dor.startsWith(year));
      const summary = {};

      results.forEach(r => {
        summary[r.rank] = (summary[r.rank] || 0) + 1;
      });

      const summaryText = Object.entries(summary).map(([rank, count]) => `<li>${rank}: ${count}</li>`).join("");

      document.getElementById("retirementResults").innerHTML = `
        <h4>Retirements in ${year}</h4>
        <p><b>Summary:</b></p>
        <ul>${summaryText}</ul>
        <p><b>Detailed List:</b></p>
        <ol>${results.map(r => `<li>${r.name} (${r.token}) - ${r.rank} - ${r.dor}</li>`).join("")}</ol>
      `;
    }

    loadData();
  </script>
</body>
</html>