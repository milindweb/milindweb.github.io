<body>
  <div>
    <h1>NAD Promotion System</h1>
    
    <!-- Search with Autocomplete -->
    <div>
      <input type="text" id="tokenSearch" placeholder="Type token (e.g. 18675)" 
             oninput="showTokenSuggestions()" autocomplete="off">
      <div id="tokenSuggestions"></div>
      <button onclick="findEmployee()">Search</button>
      <div id="searchStatus"></div>
    </div>

    <!-- Results Display -->
    <div id="results">
      <!-- Dynamically populated -->
    </div>
  </div>

  <script>
    // Configuration
    const SHEET_ID = '1_qwciFgPC98jL9-4j4p7qLTK639xF0Gkrddp9E4bGQo';
    const API_KEY = 'AIzaSyDxJaP_1q8J0q4tHKnQeQbQjZQJwYVH2F8';
    let employees = [];
    let posts = {};
    let columnIndex = {};

    // Main initialization
    async function initialize() {
      await loadEmployeeData();
      await loadSanctionedPosts();
      document.getElementById('tokenSearch').focus();
    }

    // Load employee data from Sheet1
    async function loadEmployeeData() {
      try {
        showStatus("Loading employee records...");
        const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Sheet1?key=${API_KEY}`);
        const data = await response.json();
        
        // Map dynamic columns
        const headers = data.values[0].map(h => h.trim());
        columnIndex = {
          token: headers.indexOf('Token No'),
          name: headers.indexOf('Name'),
          post: headers.indexOf('Post'),
          rank: headers.indexOf('Current Rank'),
          rankDate: headers.indexOf('Date of Rank'),
          retireDate: headers.indexOf('Retirement Date')
        };
        
        // Validate required columns
        if (columnIndex.token === -1) throw new Error("Token No column missing");
        
        // Process data
        employees = data.values.slice(1)
          .map(row => ({
            token: row[columnIndex.token]?.trim(),
            name: row[columnIndex.name] || 'Unknown',
            post: row[columnIndex.post] || 'Unassigned',
            rank: row[columnIndex.rank] || 'Unknown',
            rankDate: row[columnIndex.rankDate],
            retireDate: row[columnIndex.retireDate]
          }))
          .filter(e => e.token); // Remove empty tokens
        
        showStatus(`Loaded ${employees.length} employees`);
      } catch (error) {
        showStatus(`Error: ${error.message}`, true);
        console.error("Data load failed:", error);
      }
    }

    // Load sanctioned posts from Sheet2
    async function loadSanctionedPosts() {
      try {
        showStatus("Loading post data...");
        const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Sheet2?key=${API_KEY}`);
        const data = await response.json();
        
        const headers = data.values[0].map(h => h.trim());
        data.values.slice(1).forEach(row => {
          const post = row[0]?.trim();
          if (post) {
            posts[post] = {
              SK: parseInt(row[headers.indexOf('SK')]) || 0,
              HSKII: parseInt(row[headers.indexOf('HSK II')]) || 0,
              HSKI: parseInt(row[headers.indexOf('HSK I')]) || 0,
              MCM: parseInt(row[headers.indexOf('MCM')]) || 0
            };
          }
        });
      } catch (error) {
        console.error("Failed to load posts:", error);
      }
    }

    // Autocomplete suggestions
    function showTokenSuggestions() {
      const input = document.getElementById('tokenSearch').value.trim();
      const container = document.getElementById('tokenSuggestions');
      container.innerHTML = '';
      
      if (input.length < 2) {
        container.style.display = 'none';
        return;
      }
      
      const matches = employees.filter(e => 
        e.token.includes(input)
      ).slice(0, 5);
      
      if (matches.length === 0) {
        container.style.display = 'none';
        return;
      }
      
      matches.forEach(emp => {
        const div = document.createElement('div');
        div.textContent = `${emp.token} - ${emp.name}`;
        div.onclick = () => {
          document.getElementById('tokenSearch').value = emp.token;
          container.style.display = 'none';
          findEmployee();
        };
        container.appendChild(div);
      });
      
      container.style.display = 'block';
    }

    // Find employee and display results
    function findEmployee() {
      const token = document.getElementById('tokenSearch').value.trim();
      const resultDiv = document.getElementById('results');
      resultDiv.innerHTML = '';
      
      if (!token) {
        showStatus("Please enter a token number", true);
        return;
      }
      
      const employee = employees.find(e => e.token === token);
      if (!employee) {
        showStatus(`Token ${token} not found`, true);
        return;
      }
      
      displayEmployeeProfile(employee);
      showStatus(`Showing ${employee.name} (${employee.token})`);
    }

    // Display employee profile and timeline
    function displayEmployeeProfile(emp) {
      const resultDiv = document.getElementById('results');
      
      // Basic info
      resultDiv.innerHTML = `
        <div class="employee-card">
          <h2>${emp.name}</h2>
          <p>Token: ${emp.token}</p>
          <p>Post: ${emp.post}</p>
          <p>Current Rank: ${emp.rank}</p>
          <p>Retirement Year: ${emp.retireDate ? new Date(emp.retireDate).getFullYear() : 'N/A'}</p>
        </div>
        <div id="promotionTimeline"></div>
        <div id="vacancySummary"></div>
      `;
      
      calculatePromotionPath(emp);
      showVacancySummary(emp.post);
    }

    // Calculate promotion timeline
    function calculatePromotionPath(emp) {
      const ranks = ['SK', 'HSKII', 'HSKI', 'MCM'];
      const currentRank = ranks.indexOf(emp.rank.replace(' ', ''));
      if (currentRank === -1) return;
      
      const timelineDiv = document.getElementById('promotionTimeline');
      timelineDiv.innerHTML = `
        <h3>Promotion Timeline</h3>
        <table border="1">
          <thead>
            <tr>
              <th>Current Rank</th>
              <th>Next Rank</th>
              <th>Promotion Year</th>
              <th>Retirements Needed</th>
            </tr>
          </thead>
          <tbody id="timelineBody"></tbody>
        </table>
      `;
      
      const tbody = document.getElementById('timelineBody');
      const postData = posts[emp.post] || {};
      
      for (let i = currentRank; i < ranks.length - 1; i++) {
        const current = ranks[i];
        const next = ranks[i+1];
        
        // Calculate vacancies
        const sanctioned = postData[next] || 0;
        const currentHolders = employees.filter(e => 
          e.post === emp.post && e.rank.replace(' ', '') === next
        );
        const retiring = currentHolders.filter(e => 
          e.retireDate && !isNaN(new Date(e.retireDate))
        );
        
        // Group retirements by year
        const retirementYears = {};
        retiring.forEach(e => {
          const year = new Date(e.retireDate).getFullYear();
          retirementYears[year] = (retirementYears[year] || 0) + 1;
        });
        
        // Determine promotion year
        let promoYear = 'N/A';
        let retirements = '-';
        const vacancies = (sanctioned - currentHolders.length) + retiring.length;
        
        if (vacancies > 0) {
          if (retiring.length > 0) {
            const earliestYear = Math.min(...Object.keys(retirementYears).map(Number));
            promoYear = earliestYear + 1;
            retirements = Object.entries(retirementYears)
              .map(([y,c]) => `${c} in ${y}`)
              .join(', ');
          } else {
            promoYear = new Date().getFullYear() + 1;
          }
        } else {
          promoYear = 'Blocked';
          retirements = `${Math.abs(vacancies)} more needed`;
        }
        
        // Add to timeline
        const row = tbody.insertRow();
        row.insertCell().textContent = current;
        row.insertCell().textContent = next;
        row.insertCell().textContent = promoYear;
        row.insertCell().textContent = retirements;
      }
    }

    // Show vacancy summary for a post
    function showVacancySummary(post) {
      const summaryDiv = document.getElementById('vacancySummary');
      const postData = posts[post] || {};
      
      summaryDiv.innerHTML = `
        <h3>Vacancy Summary: ${post}</h3>
        <table border="1">
          <thead>
            <tr>
              <th>Rank</th>
              <th>Sanctioned</th>
              <th>Filled</th>
              <th>Vacancies</th>
              <th>Retirements</th>
            </tr>
          </thead>
          <tbody id="summaryBody"></tbody>
        </table>
      `;
      
      const tbody = document.getElementById('summaryBody');
      
      for (const rank in postData) {
        const sanctioned = postData[rank];
        const currentHolders = employees.filter(e => 
          e.post === post && e.rank.replace(' ', '') === rank
        );
        const retiring = currentHolders.filter(e => 
          e.retireDate && !isNaN(new Date(e.retireDate))
        );
        
        // Group retirements by year
        const retirementYears = {};
        retiring.forEach(e => {
          const year = new Date(e.retireDate).getFullYear();
          retirementYears[year] = (retirementYears[year] || 0) + 1;
        });
        
        const retirementsText = Object.entries(retirementYears)
          .map(([y,c]) => `${c} in ${y}`)
          .join(', ') || '-';
        
        const row = tbody.insertRow();
        row.insertCell().textContent = rank;
        row.insertCell().textContent = sanctioned;
        row.insertCell().textContent = currentHolders.length;
        row.insertCell().textContent = (sanctioned - currentHolders.length) + retiring.length;
        row.insertCell().textContent = retirementsText;
      }
    }

    // Helper function to show status messages
    function showStatus(message, isError = false) {
      const statusDiv = document.getElementById('searchStatus');
      statusDiv.textContent = message;
      statusDiv.style.color = isError ? 'red' : 'green';
    }

    // Initialize on page load
    window.onload = initialize;
  </script>
</body>