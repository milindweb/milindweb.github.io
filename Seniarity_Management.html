<div>
  <h3>Search by Token No.</h3>
  <input type="text" id="tokenSearch" placeholder="Enter Token No">
  <button onclick="searchByToken()">Search</button>
  
  <h3>Combine Posts</h3>
  <select id="post1"></select>
  <select id="post2"></select>
  <button onclick="combinePosts()">Combine & Show Seniority</button>
  
  <div id="result"></div>
</div>

<script>
// Your Google Sheet published as CSV (replace /edit?... with /gviz/tq?tqx=out:csv)
const sheetUrl = "https://docs.google.com/spreadsheets/d/1_qwciFgPC98jL9-4j4p7qLTK639xF0Gkrddp9E4bGQo/export?format=csv";

let employeeData = [];

fetch(sheetUrl)
  .then(res => res.text())
  .then(data => {
    const rows = data.split("\n").map(r => r.split(","));
    const headers = rows[0];
    employeeData = rows.slice(1).map(r => {
      let obj = {};
      headers.forEach((h, i) => obj[h.trim()] = r[i]?.trim());
      return obj;
    });
    populatePosts();
  });

function populatePosts() {
  let posts = [...new Set(employeeData.map(e => e["Category"]))];
  posts.forEach(p => {
    document.getElementById("post1").innerHTML += `<option>${p}</option>`;
    document.getElementById("post2").innerHTML += `<option>${p}</option>`;
  });
}

// Token Search
function searchByToken() {
  const token = document.getElementById("tokenSearch").value.trim();
  const candidate = employeeData.find(e => e["Tokan No."] === token);
  
  if (!candidate) {
    document.getElementById("result").innerHTML = "<p>No employee found.</p>";
    return;
  }

  let html = `<h4>${candidate["Name"]} (Token: ${candidate["Tokan No."]})</h4>`;
  html += `<p>Post: ${candidate["Category"]}, Rank: ${candidate["Rank"]}</p>`;
  html += `<p>Date of Retirement: ${candidate["Date of Retirement"]}</p>`;

  // Seniority in current rank
  const sameRank = employeeData.filter(e => e["Category"] === candidate["Category"] && e["Rank"] === candidate["Rank"]);
  sameRank.sort((a,b) => new Date(a[`Date of ${candidate["Rank"]}`]) - new Date(b[`Date of ${candidate["Rank"]}`]));

  const position = sameRank.findIndex(e => e["Tokan No."] === candidate["Tokan No."]) + 1;
  html += `<p>Position in ${candidate["Rank"]}: ${position} of ${sameRank.length}</p>`;

  // Promotion Timeline
  const ranks = ["SK","HSK 2","HSK 1","MCM"];
  let startRankIndex = ranks.indexOf(candidate["Rank"]);
  html += `<h5>Promotion Timeline</h5><ul>`;
  for (let i=startRankIndex; i<ranks.length-1; i++) {
    const nextRank = ranks[i+1];
    const dateField = `Date of ${ranks[i]}`;
    const nextDateField = `Date of ${nextRank}`;
    
    if (!candidate[nextDateField] || new Date(candidate[nextDateField]) > new Date(candidate["Date of Retirement"])) {
      html += `<li>${candidate["Category"]} ${nextRank} → Not Promoted (Retired ${candidate["Date of Retirement"]})</li>`;
      break;
    } else {
      html += `<li>${candidate["Category"]} ${nextRank} → ${candidate[nextDateField]}</li>`;
    }
  }
  html += `</ul>`;

  document.getElementById("result").innerHTML = html;
}

// Combine Posts
function combinePosts() {
  const p1 = document.getElementById("post1").value;
  const p2 = document.getElementById("post2").value;

  const combined = employeeData.filter(e => e["Category"] === p1 || e["Category"] === p2);

  let html = `<h4>Combined Seniority: ${p1} + ${p2}</h4>`;
  ["SK","HSK 2","HSK 1","MCM"].forEach(rank => {
    const rankList = combined.filter(e => e["Rank"] === rank);
    rankList.sort((a,b) => new Date(a[`Date of ${rank}`]) - new Date(b[`Date of ${rank}`]));
    html += `<h5>${rank} (${rankList.length})</h5><ol>`;
    rankList.forEach(e => {
      html += `<li>${e["Name"]} (Token: ${e["Tokan No."]}) - Retires ${e["Date of Retirement"]}</li>`;
    });
    html += `</ol>`;
  });
  
  document.getElementById("result").innerHTML = html;
}
</script>