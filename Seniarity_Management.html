<body>
  <div>
    <h1>NAD Promotion Timeline Calculator</h1>
    
    <!-- Token Search Section -->
    <div>
      <h2>Employee Search</h2>
      <input type="text" id="tokenInput" placeholder="Enter Token Number">
      <button onclick="searchEmployee()">Search</button>
      <div id="autocompleteResults"></div>
    </div>
    
    <!-- Results Section -->
    <div id="results">
      <!-- Employee Details -->
      <div id="employeeDetails"></div>
      
      <!-- Promotion Timeline -->
      <div>
        <h3>Promotion Timeline</h3>
        <table id="promotionTimeline" border="1">
          <thead>
            <tr>
              <th>Current Rank</th>
              <th>Next Rank</th>
              <th>Promotion Year</th>
              <th>Retirements Needed</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      
      <!-- Vacancy Summary -->
      <div>
        <h3>Vacancy Summary</h3>
        <table id="vacancySummary" border="1">
          <thead>
            <tr>
              <th>Post</th>
              <th>Rank</th>
              <th>Sanctioned</th>
              <th>Filled</th>
              <th>Vacancies</th>
              <th>Retirements (Year)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // Configuration
    const SHEET_ID = '1_qwciFgPC98jL9-4j4p7qLTK639xF0Gkrddp9E4bGQo';
    const API_KEY = 'AIzaSyDxJaP_1q8J0q4tHKnQeQbQjZQJwYVH2F8';
    let employeeData = [];
    let sanctionedPosts = {};

    // Fetch data from Google Sheets
    async function fetchData() {
      try {
        // Fetch employee data from Sheet1
        const empResponse = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Sheet1!A1:Z?key=${API_KEY}`);
        const empJson = await empResponse.json();
        
        // Process employee data
        const headers = empJson.values[0];
        employeeData = empJson.values.slice(1).map(row => ({
          tokenNo: row[headers.indexOf('Token No')],
          name: row[headers.indexOf('Name')],
          post: row[headers.indexOf('Post')],
          currentRank: row[headers.indexOf('Current Rank')],
          dateOfRank: row[headers.indexOf('Date of Rank')],
          retirementDate: row[headers.indexOf('Retirement Date')]
        }));

        // Fetch sanctioned posts from Sheet2
        const postsResponse = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Sheet2!A1:Z?key=${API_KEY}`);
        const postsJson = await postsResponse.json();
        
        // Process sanctioned posts
        const postHeaders = postsJson.values[0];
        postsJson.values.slice(1).forEach(row => {
          const post = row[0];
          sanctionedPosts[post] = {
            'SK': parseInt(row[postHeaders.indexOf('SK')]) || 0,
            'HSK II': parseInt(row[postHeaders.indexOf('HSK II')]) || 0,
            'HSK I': parseInt(row[postHeaders.indexOf('HSK I')]) || 0,
            'MCM': parseInt(row[postHeaders.indexOf('MCM')]) || 0
          };
        });

        console.log('Data loaded successfully');
      } catch (error) {
        console.error('Error loading data:', error);
        alert('Error loading data. Please check console for details.');
      }
    }

    // Search employee by token number
    function searchEmployee() {
      const token = document.getElementById('tokenInput').value.trim();
      if (!token) return;

      const employee = employeeData.find(e => e.tokenNo === token);
      if (!employee) {
        alert('Employee not found');
        return;
      }

      displayEmployeeDetails(employee);
      calculatePromotionTimeline(employee);
    }

    // Display basic employee info
    function displayEmployeeDetails(employee) {
      const detailsDiv = document.getElementById('employeeDetails');
      detailsDiv.innerHTML = `
        <h2>${employee.name}</h2>
        <p>Token: ${employee.tokenNo}</p>
        <p>Post: ${employee.post}</p>
        <p>Current Rank: ${employee.currentRank}</p>
        <p>Retirement Year: ${employee.retirementDate ? new Date(employee.retirementDate).getFullYear() : 'N/A'}</p>
      `;
    }

    // Calculate and display promotion timeline
    function calculatePromotionTimeline(employee) {
      const ranks = ['SK', 'HSK II', 'HSK I', 'MCM'];
      const currentRankIndex = ranks.indexOf(employee.currentRank);
      const timelineBody = document.querySelector('#promotionTimeline tbody');
      timelineBody.innerHTML = '';

      // Get sanctioned posts data for employee's post
      const postData = sanctionedPosts[employee.post] || {};

      for (let i = currentRankIndex; i < ranks.length - 1; i++) {
        const currentRank = ranks[i];
        const nextRank = ranks[i + 1];
        
        // Calculate vacancies
        const sanctioned = postData[nextRank] || 0;
        const currentEmployees = employeeData.filter(e => 
          e.post === employee.post && e.currentRank === nextRank
        );
        const filled = currentEmployees.length;
        const retiring = currentEmployees.filter(e => 
          e.retirementDate && new Date(e.retirementDate).getFullYear() < new Date().getFullYear() + 5
        ).length;
        const vacancies = (sanctioned - filled) + retiring;

        // Determine promotion year
        let promotionYear = 'N/A';
        let retirementsNeeded = '-';
        
        if (vacancies > 0) {
          promotionYear = new Date().getFullYear() + 1;
          if (retiring > 0) {
            const retirementYears = [...new Set(retiring.map(e => 
              new Date(e.retirementDate).getFullYear()
            ))].sort();
            retirementsNeeded = `${retiring.length} (${retirementYears.join(', ')})`;
          }
        } else {
          promotionYear = 'Blocked';
          retirementsNeeded = `${Math.abs(vacancies)} needed`;
        }

        // Add to timeline table
        const row = timelineBody.insertRow();
        row.insertCell().textContent = currentRank;
        row.insertCell().textContent = nextRank;
        row.insertCell().textContent = promotionYear;
        row.insertCell().textContent = retirementsNeeded;
      }

      // Update vacancy summary
      updateVacancySummary(employee.post);
    }

    // Update vacancy summary table
    function updateVacancySummary(post) {
      const summaryBody = document.querySelector('#vacancySummary tbody');
      summaryBody.innerHTML = '';
      const postData = sanctionedPosts[post] || {};

      for (const rank in postData) {
        const sanctioned = postData[rank];
        const currentEmployees = employeeData.filter(e => 
          e.post === post && e.currentRank === rank
        );
        const filled = currentEmployees.length;
        const retiring = currentEmployees.filter(e => 
          e.retirementDate && new Date(e.retirementDate).getFullYear() < new Date().getFullYear() + 5
        );
        
        // Group retirements by year
        const retirementYears = {};
        retiring.forEach(e => {
          const year = new Date(e.retirementDate).getFullYear();
          retirementYears[year] = (retirementYears[year] || 0) + 1;
        });
        
        const retirementsText = Object.entries(retirementYears)
          .map(([year, count]) => `${count} (${year})`)
          .join(', ') || '-';

        const row = summaryBody.insertRow();
        row.insertCell().textContent = post;
        row.insertCell().textContent = rank;
        row.insertCell().textContent = sanctioned;
        row.insertCell().textContent = filled;
        row.insertCell().textContent = (sanctioned - filled) + retiring.length;
        row.insertCell().textContent = retirementsText;
      }
    }

    // Initialize on page load
    window.onload = fetchData;
  </script>
</body>