<!DOCTYPE html>
<html>
<head>
    <title>NAD Seniority System - Data Verification</title>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 10px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .highlight {
            background-color: #ffffcc;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success {
            background-color: #dff0d8;
            color: #3c763d;
        }
        .error {
            background-color: #f2dede;
            color: #a94442;
        }
    </style>
</head>
<body>
    <h1>NAD Seniority System - Data Verification</h1>
    
    <div id="statusMessage" class="status"></div>
    
    <div>
        <h2>Employee Search</h2>
        <input type="text" id="tokenInput" placeholder="Enter Token Number" oninput="showSuggestions()">
        <div id="suggestions" style="display:none;"></div>
        <button onclick="searchEmployee()">Search</button>
    </div>
    
    <div id="searchResults"></div>
    
    <h2>Sheet1 - Employee Data</h2>
    <div id="sheet1Data"></div>
    
    <h2>Sheet2 - Sanctioned Posts</h2>
    <div id="sheet2Data"></div>

    <script>
        // Configuration
        const SHEET_ID = '1_qwciFgPC98jL9-4j4p7qLTK639xF0Gkrddp9E4bGQo';
        const API_KEY = 'AIzaSyDxJaP_1q8J0q4tHKnQeQbQjZQJwYVH2F8';
        let employeeData = [];
        let sanctionedPosts = {};
        let columnMap = {};

        // Main initialization
        async function initialize() {
            showStatus("Loading data...");
            await loadSheet1();
            await loadSheet2();
            showStatus("Data loaded successfully!", "success");
            displayAllData();
        }

        // Load Sheet1 (Employee Data)
        async function loadSheet1() {
            try {
                const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Sheet1!A:Z?key=${API_KEY}`);
                if (!response.ok) throw new Error("Failed to fetch Sheet1");
                
                const data = await response.json();
                if (!data.values) throw new Error("No data in Sheet1");
                
                // Map columns dynamically
                const headers = data.values[0].map(h => h.trim());
                columnMap = {
                    tokenNo: headers.indexOf('Token No'),
                    name: headers.indexOf('Name'),
                    post: headers.indexOf('Post'),
                    currentRank: headers.indexOf('Current Rank'),
                    dateOfRank: headers.indexOf('Date of Rank'),
                    retirementDate: headers.indexOf('Retirement Date')
                };
                
                // Validate required columns
                if (columnMap.tokenNo === -1) throw new Error("Token No column not found in Sheet1");
                
                // Process data
                employeeData = data.values.slice(1).map(row => ({
                    tokenNo: row[columnMap.tokenNo]?.trim() || '',
                    name: row[columnMap.name] || 'Unknown',
                    post: row[columnMap.post] || 'Unassigned',
                    currentRank: row[columnMap.currentRank] || 'Unknown',
                    dateOfRank: row[columnMap.dateOfRank],
                    retirementDate: row[columnMap.retirementDate]
                })).filter(emp => emp.tokenNo);
                
                console.log("Sheet1 data loaded:", employeeData);
            } catch (error) {
                console.error("Sheet1 load error:", error);
                throw error;
            }
        }

        // Load Sheet2 (Sanctioned Posts)
        async function loadSheet2() {
            try {
                const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Sheet2!A:Z?key=${API_KEY}`);
                if (!response.ok) throw new Error("Failed to fetch Sheet2");
                
                const data = await response.json();
                if (!data.values) throw new Error("No data in Sheet2");
                
                // Process data
                const headers = data.values[0].map(h => h.trim());
                data.values.slice(1).forEach(row => {
                    const post = row[0]?.trim();
                    if (post) {
                        sanctionedPosts[post] = {
                            'SK': parseInt(row[headers.indexOf('SK')]) || 0,
                            'HSK II': parseInt(row[headers.indexOf('HSK II')]) || 0,
                            'HSK I': parseInt(row[headers.indexOf('HSK I')]) || 0,
                            'MCM': parseInt(row[headers.indexOf('MCM')]) || 0
                        };
                    }
                });
                
                console.log("Sheet2 data loaded:", sanctionedPosts);
            } catch (error) {
                console.error("Sheet2 load error:", error);
                throw error;
            }
        }

        // Display all raw data for verification
        function displayAllData() {
            // Display Sheet1 data
            const sheet1Div = document.getElementById('sheet1Data');
            if (employeeData.length > 0) {
                sheet1Div.innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>Token No</th>
                                <th>Name</th>
                                <th>Post</th>
                                <th>Current Rank</th>
                                <th>Date of Rank</th>
                                <th>Retirement Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${employeeData.map(emp => `
                                <tr>
                                    <td>${emp.tokenNo}</td>
                                    <td>${emp.name}</td>
                                    <td>${emp.post}</td>
                                    <td>${emp.currentRank}</td>
                                    <td>${emp.dateOfRank || 'N/A'}</td>
                                    <td>${emp.retirementDate || 'N/A'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <p>Total employees: ${employeeData.length}</p>
                `;
            } else {
                sheet1Div.innerHTML = "<p>No employee data loaded</p>";
            }
            
            // Display Sheet2 data
            const sheet2Div = document.getElementById('sheet2Data');
            if (Object.keys(sanctionedPosts).length > 0) {
                sheet2Div.innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>Post</th>
                                <th>SK</th>
                                <th>HSK II</th>
                                <th>HSK I</th>
                                <th>MCM</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(sanctionedPosts).map(([post, ranks]) => `
                                <tr>
                                    <td>${post}</td>
                                    <td>${ranks['SK']}</td>
                                    <td>${ranks['HSK II']}</td>
                                    <td>${ranks['HSK I']}</td>
                                    <td>${ranks['MCM']}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else {
                sheet2Div.innerHTML = "<p>No sanctioned posts data loaded</p>";
            }
        }

        // Search functionality
        function showSuggestions() {
            const input = document.getElementById('tokenInput').value.trim();
            const suggestionsDiv = document.getElementById('suggestions');
            suggestionsDiv.innerHTML = '';
            
            if (input.length < 2) {
                suggestionsDiv.style.display = 'none';
                return;
            }
            
            const matches = employeeData.filter(emp => 
                emp.tokenNo.includes(input)
            ).slice(0, 5);
            
            if (matches.length > 0) {
                matches.forEach(emp => {
                    const div = document.createElement('div');
                    div.textContent = `${emp.tokenNo} - ${emp.name}`;
                    div.onclick = () => {
                        document.getElementById('tokenInput').value = emp.tokenNo;
                        suggestionsDiv.style.display = 'none';
                        searchEmployee();
                    };
                    suggestionsDiv.appendChild(div);
                });
                suggestionsDiv.style.display = 'block';
            } else {
                suggestionsDiv.style.display = 'none';
            }
        }

        function searchEmployee() {
            const token = document.getElementById('tokenInput').value.trim();
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '';
            
            if (!token) {
                showStatus("Please enter a token number", "error");
                return;
            }
            
            const employee = employeeData.find(emp => emp.tokenNo === token);
            if (!employee) {
                showStatus(`Employee with token ${token} not found`, "error");
                return;
            }
            
            // Display employee details
            resultsDiv.innerHTML = `
                <h3>Employee Details</h3>
                <table>
                    <tr><th>Token No</th><td>${employee.tokenNo}</td></tr>
                    <tr><th>Name</th><td>${employee.name}</td></tr>
                    <tr><th>Post</th><td>${employee.post}</td></tr>
                    <tr><th>Current Rank</th><td>${employee.currentRank}</td></tr>
                    <tr><th>Date of Rank</th><td>${employee.dateOfRank || 'N/A'}</td></tr>
                    <tr><th>Retirement Date</th><td>${employee.retirementDate || 'N/A'}</td></tr>
                </table>
                
                <h3>Promotion Timeline</h3>
                ${generatePromotionTimeline(employee)}
            `;
            
            showStatus(`Showing results for token: ${token}`, "success");
        }

        function generatePromotionTimeline(employee) {
            const ranks = ['SK', 'HSK II', 'HSK I', 'MCM'];
            const currentRankIndex = ranks.indexOf(employee.currentRank);
            
            if (currentRankIndex === -1) {
                return "<p>Invalid current rank</p>";
            }
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Current Rank</th>
                            <th>Next Rank</th>
                            <th>Promotion Year</th>
                            <th>Retirements Needed</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            const postData = sanctionedPosts[employee.post] || {};
            
            for (let i = currentRankIndex; i < ranks.length - 1; i++) {
                const currentRank = ranks[i];
                const nextRank = ranks[i + 1];
                
                // Calculate vacancies
                const sanctioned = postData[nextRank] || 0;
                const currentEmployees = employeeData.filter(e => 
                    e.post === employee.post && e.currentRank === nextRank
                );
                const filled = currentEmployees.length;
                const retiring = currentEmployees.filter(e => 
                    e.retirementDate && !isNaN(new Date(e.retirementDate))
                );
                
                // Group retirements by year
                const retirementYears = {};
                retiring.forEach(e => {
                    const year = new Date(e.retirementDate).getFullYear();
                    retirementYears[year] = (retirementYears[year] || 0) + 1;
                });
                
                // Determine promotion year
                let promotionYear = 'N/A';
                let retirementsNeeded = '-';
                const vacancies = (sanctioned - filled) + retiring.length;
                
                if (vacancies > 0) {
                    if (retiring.length > 0) {
                        const earliestYear = Math.min(...Object.keys(retirementYears).map(Number));
                        promotionYear = earliestYear + 1;
                        retirementsNeeded = Object.entries(retirementYears)
                            .map(([year, count]) => `${count} in ${year}`)
                            .join(', ');
                    } else {
                        promotionYear = new Date().getFullYear() + 1;
                    }
                } else {
                    promotionYear = 'Blocked';
                    retirementsNeeded = `${Math.abs(vacancies)} more needed`;
                }
                
                html += `
                    <tr>
                        <td>${currentRank}</td>
                        <td>${nextRank}</td>
                        <td>${promotionYear}</td>
                        <td>${retirementsNeeded}</td>
                    </tr>
                `;
            }
            
            html += `
                    </tbody>
                </table>
            `;
            
            return html;
        }

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        // Initialize on page load
        window.onload = initialize;
    </script>
</body>
</html>