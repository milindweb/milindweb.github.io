<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>NAD Seniority & Promotion Management</title>
</head>
<body>
  <h2>NAD Seniority & Promotion Management</h2>

  <h3>Search Employee</h3>
  <input type="text" id="tokenInput" placeholder="Enter Token Number" oninput="showSuggestions()">
  <div id="suggestions" style="border:1px solid #ccc;display:none;"></div>
  <button onclick="searchEmployee()">Search</button>

  <div id="employeeDetails"></div>

  <h3>Employee Data (Sheet1)</h3>
  <div id="sheet1Data"></div>

  <h3>Sanctioned Posts (Sheet2)</h3>
  <div id="sheet2Data"></div>

<script>
// Links to published CSV exports
const sheet1URL = "https://docs.google.com/spreadsheets/d/1_qwciFgPC98jL9-4j4p7qLTK639xF0Gkrddp9E4bGQo/export?format=csv&gid=0";
const sheet2URL = "https://docs.google.com/spreadsheets/d/1_qwciFgPC98jL9-4j4p7qLTK639xF0Gkrddp9E4bGQo/export?format=csv&gid=378290522";

let employees = [];
let sanctionedPosts = [];
let headers1 = [];
let headers2 = [];

// Robust CSV parser (handles quotes and commas inside cells)
function parseCSV(text) {
  const rows = [];
  let row = [];
  let cell = "";
  let insideQuote = false;

  for (let i = 0; i < text.length; i++) {
    const char = text[i];
    if (char === '"') {
      if (insideQuote && text[i + 1] === '"') {
        cell += '"';
        i++;
      } else {
        insideQuote = !insideQuote;
      }
    } else if (char === ',' && !insideQuote) {
      row.push(cell);
      cell = "";
    } else if ((char === '\n' || char === '\r') && !insideQuote) {
      if (cell || row.length) {
        row.push(cell);
        rows.push(row);
        row = [];
        cell = "";
      }
    } else {
      cell += char;
    }
  }
  if (cell || row.length) row.push(cell), rows.push(row);
  return rows;
}

// Load both sheets
async function loadData() {
  try {
    // Sheet1
    const res1 = await fetch(sheet1URL);
    const text1 = await res1.text();
    const rows1 = parseCSV(text1);
    headers1 = rows1[0];
    employees = rows1.slice(1).map(r => {
      let obj = {};
      headers1.forEach((h, i) => obj[h] = r[i] || "");
      return obj;
    });

    // Sheet2
    const res2 = await fetch(sheet2URL);
    const text2 = await res2.text();
    const rows2 = parseCSV(text2);
    headers2 = rows2[0];
    sanctionedPosts = rows2.slice(1).map(r => {
      let obj = {};
      headers2.forEach((h, i) => obj[h] = r[i] || "");
      return obj;
    });

    displayAllData();
  } catch (err) {
    document.getElementById("sheet1Data").innerHTML = "<p>Error loading data. Did you publish the sheet?</p>";
    console.error(err);
  }
}

// Autocomplete Suggestions
function showSuggestions() {
  const input = document.getElementById("tokenInput").value.trim().toLowerCase();
  const suggestionsDiv = document.getElementById("suggestions");
  suggestionsDiv.innerHTML = "";
  if (input.length < 2) {
    suggestionsDiv.style.display = "none";
    return;
  }
  const matches = employees.filter(e => (e["Tokan No."] || "").toLowerCase().includes(input)).slice(0, 5);
  matches.forEach(emp => {
    const div = document.createElement("div");
    div.textContent = `${emp["Tokan No."]} - ${emp["Name"]}`;
    div.style.cursor = "pointer";
    div.onclick = () => {
      document.getElementById("tokenInput").value = emp["Tokan No."];
      suggestionsDiv.style.display = "none";
      searchEmployee();
    };
    suggestionsDiv.appendChild(div);
  });
  suggestionsDiv.style.display = matches.length > 0 ? "block" : "none";
}

// Search Employee
function searchEmployee() {
  const token = document.getElementById("tokenInput").value.trim();
  const div = document.getElementById("employeeDetails");
  div.innerHTML = "";
  const emp = employees.find(e => e["Tokan No."] === token);
  if (!emp) {
    div.innerHTML = `<p>No employee found with token: ${token}</p>`;
    return;
  }
  div.innerHTML = `
    <h4>Employee Details</h4>
    <table border="1" cellpadding="5">
      ${headers1.map(h => `<tr><th>${h}</th><td>${emp[h]}</td></tr>`).join("")}
    </table>
    <h4>Promotion Timeline</h4>
    ${promotionTimeline(emp)}
  `;
}

// Promotion Timeline
function promotionTimeline(emp) {
  const rankOrder = ["Tradesman Mate","USL","SSK","SK","HSK II","HSK I","MCM"];
  const currentRank = emp["Rank"];
  const idx = rankOrder.indexOf(currentRank);
  if (idx === -1) return "<p>Rank not in promotion ladder</p>";

  let html = "<ul>";
  for (let i = idx + 1; i < rankOrder.length; i++) {
    const nextRank = rankOrder[i];
    const vacancyInfo = sanctionedPosts.find(p => p["Rank"] === nextRank && p["Post"] === emp["Post"]);
    const sanctioned = vacancyInfo ? parseInt(vacancyInfo["Sactioned vacancy"]) || 0 : 0;
    const seniors = employees.filter(e => e["Rank"] === nextRank).length;
    const estimate = sanctioned > 0 ? Math.ceil(seniors / sanctioned) : "N/A";
    html += `<li>${nextRank}: ~${estimate} years</li>`;
  }
  html += "</ul>";
  return html;
}

// Show All Data
function displayAllData() {
  // Sheet1
  document.getElementById("sheet1Data").innerHTML = `
    <table border="1" cellpadding="5">
      <thead><tr>${headers1.map(h => `<th>${h}</th>`).join("")}</tr></thead>
      <tbody>
        ${employees.map(e => `<tr>${headers1.map(h => `<td>${e[h]}</td>`).join("")}</tr>`).join("")}
      </tbody>
    </table>
    <p>Total employees: ${employees.length}</p>
  `;
  // Sheet2
  document.getElementById("sheet2Data").innerHTML = `
    <table border="1" cellpadding="5">
      <thead><tr>${headers2.map(h => `<th>${h}</th>`).join("")}</tr></thead>
      <tbody>
        ${sanctionedPosts.map(p => `<tr>${headers2.map(h => `<td>${p[h]}</td>`).join("")}</tr>`).join("")}
      </tbody>
    </table>
  `;
}

window.onload = loadData;
</script>
</body>
</html>